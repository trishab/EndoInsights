import argparse
import pandas as pd
from Bio import Medline
import matplotlib.pyplot as plt
from config import FILE_PATHS

# Command line arguments override config defaults
parser = argparse.ArgumentParser(description="Analyze PubMed IPF data")
parser.add_argument(
    "--genetic_mechanisms_file",
    default=FILE_PATHS["genetic_mechanisms_file"],
    help="Path to genetic mechanisms endometriosis file",
)
parser.add_argument(
    "--all_endometriosis_file",
    default=FILE_PATHS["all_endometriosis_file"],
    help="Path to all endometriosis studies file",
)
args = parser.parse_args()

genetic_mechanisms_file = args.genetic_mechanisms_file
all_endometriosis_file = args.all_endometriosis_file

def parse_medline_file(file_path):
    with open(file_path, 'r') as handle:
        records = Medline.parse(handle)
        records = list(records)
    return records

def extract_publication_details(records):
    details = []
    for record in records:
        title = record.get('TI', 'No title')
        authors = ', '.join(record.get('AU', ['No authors']))
        year = record.get('DP', 'No date').split(" ")[0]
        details.append({'Title': title, 'Authors': authors, 'Year': year})
    return details

def extract_publication_years(details):
    years = [detail['Year'] for detail in details]
    return years

def count_publications_per_year(years):
    # Convert years to a pandas Series
    years = pd.Series(years)
    # Convert years to integers, handling any non-numeric values
    years = pd.to_numeric(years, errors='coerce').dropna().astype(int)
    # Filter out years beyond 2023
    years = years[years <= 2023]
    year_range = range(years.min(), years.max() + 1)
    year_counts = years.value_counts().reindex(year_range, fill_value=0).sort_index()
    return year_counts

def add_labels(ax, counts, label_interval=20, final_year=2023):
    for year in range(counts.index.min(), final_year + 1, label_interval):
        total = counts.loc[:year].sum()
        ax.text(year, counts.loc[year], f'{total}', fontsize=10, ha='center', va='bottom')
    # Label for the final year
    final_total = counts.loc[:final_year].sum()
    ax.text(final_year, counts.loc[final_year], f'{final_total}', fontsize=10, ha='center', va='bottom')

# Parse the data
genetic_records = parse_medline_file(genetic_mechanisms_file)
all_records = parse_medline_file(all_endometriosis_file)

# Extract publication details and years
genetic_details = extract_publication_details(genetic_records)
all_details = extract_publication_details(all_records)

genetic_years = extract_publication_years(genetic_details)
all_years = extract_publication_years(all_details)

# Count publications per year for both datasets
genetic_counts = count_publications_per_year(genetic_years)
all_counts = count_publications_per_year(all_years)

# Ensure the years align between the datasets
year_range = range(
    min(genetic_counts.index.min(), all_counts.index.min()),
    max(genetic_counts.index.max(), all_counts.index.max()) + 1
)

genetic_counts = genetic_counts.reindex(year_range, fill_value=0)
all_counts = all_counts.reindex(year_range, fill_value=0)

# Plot the data
plt.figure(figsize=(12, 8))
plt.plot(genetic_counts.index, genetic_counts.values, label='Genetic Mechanisms of Endometriosis')
plt.plot(all_counts.index, all_counts.values, label='All Endometriosis Studies', linestyle='--')

# Add labels every 20 years and at 2023
ax = plt.gca()
add_labels(ax, all_counts, label_interval=20, final_year=2023)
add_labels(ax, genetic_counts, label_interval=20, final_year=2023)

plt.xlabel('Year')
plt.ylabel('Number of Publications')
plt.title('PubMed Articles Related to Endometriosis')
plt.legend()
plt.grid(True)
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()
